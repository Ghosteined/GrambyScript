<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GrambyScript Editor</title>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background-color: #1e1e1e;
      font-family: sans-serif;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    #top-bar {
      height: 35px;
      background-color: #2d2d2d;
      display: flex;
      align-items: center;
      padding: 0 10px;
      border-bottom: 1px solid #3c3c3c;
      justify-content: space-between;
    }

    #run-button {
      background-color: #0e639c;
      border: none;
      color: white;
      padding: 4px 12px;
      font-size: 13px;
      height: 26px;
      border-radius: 4px;
      cursor: pointer;
    }

    #run-button:hover {
      background-color: #1177bb;
    }

    #font-size-controls {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #font-size-controls button {
      background-color: #3c3c3c;
      border: 1px solid #555;
      color: white;
      width: 26px;
      height: 26px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #font-size-controls button:hover {
      background-color: #4f4f4f;
    }

    #editor-container {
      position: relative;
      flex-grow: 1;
      overflow: hidden;
    }

    #container {
      position: absolute;
      top: 0; right: 0; bottom: 0; left: 0;
    }

    #modal-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 5;
    }

    #output-box {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #252526;
      border: 1px solid #3c3c3c;
      padding: 16px 20px;
      border-radius: 6px;
      max-width: 60%;
      min-width: 400px;
      min-height: 100px;
      z-index: 10;
      color: #cccccc;
      font-family: monospace;
      font-size: 14px;
      display: none;
      box-shadow: 0 0 10px rgba(0,0,0,0.7);
    }

    #output-box h3 {
      margin: 0 0 10px;
      font-size: 15px;
      color: #ffffff;
      border-bottom: 1px solid #444;
      padding-bottom: 4px;
    }

    #output-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #output-text {
      white-space: pre-wrap;
      word-break: break-word;
      flex-grow: 1;
    }

    #copy-icon {
      cursor: pointer;
      font-size: 16px;
      margin-left: 10px;
      color: #cccccc;
    }

    #copy-icon:hover {
      color: white;
    }

    #close-button {
      position: absolute;
      top: 6px;
      right: 8px;
      font-size: 16px;
      color: #888;
      cursor: pointer;
    }

    #close-button:hover {
      color: white;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="top-bar">
      <button id="run-button">Run</button>
      <div id="font-size-controls">
        <button id="font-decrease" title="Decrease font size">-</button>
        <button id="font-increase" title="Increase font size">+</button>
      </div>
    </div>
    <div id="editor-container">
      <div id="container"></div>

      <div id="modal-overlay"></div>

      <div id="output-box">
        <div id="close-button" title="Close">âœ–</div>
        <h3>Output</h3>
        <div id="output-content">
          <span id="output-text">Hello world !</span>
          <span id="copy-icon" title="Copy to clipboard">ðŸ“‹</span>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { Parser, CompileStack } from './compiler.js';

    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
    require(['vs/editor/editor.main'], function () {
      monaco.languages.register({ id: 'grambyscript' });

      monaco.languages.setMonarchTokensProvider('grambyscript', {
        tokenizer: {
          root: [
            [/\binput\b|\boutput\b/, 'keyword'],
            [/\band\b|\bor\b|\bnand\b|\bnor\b|\bxor\b|\bxnor\b|\bnot\b/, 'gate'],
            [/\/[^/]*\//, 'comment'],
            [/[A-Z_][A-Z0-9_]*/, 'variable'],
            [/=|;/, 'delimiter'],
          ]
        }
      });

      monaco.languages.registerCompletionItemProvider('grambyscript', {
        provideCompletionItems: function(model, position) {
          const word = model.getWordUntilPosition(position);
          const range = {
            startLineNumber: position.lineNumber,
            endLineNumber: position.lineNumber,
            startColumn: word.startColumn,
            endColumn: word.endColumn,
          };
          
          let suggestions = [
            {
              label: 'input',
              kind: monaco.languages.CompletionItemKind.Keyword,
              insertText: 'input ${1:VAR_NAME};',
              insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
              documentation: 'Declare an input variable.',
              range: range,
            },
            {
              label: 'output',
              kind: monaco.languages.CompletionItemKind.Keyword,
              insertText: 'output ${1:VAR_NAME} = ${2:VALUE};',
              insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
              documentation: 'Declare an output variable.',
              range: range,
            },
            ...['and', 'or', 'nand', 'nor', 'xor', 'xnor', 'not'].map(gate => ({
              label: gate,
              kind: monaco.languages.CompletionItemKind.Function,
              insertText: gate.toUpperCase(),
              documentation: `A ${gate.toUpperCase()} logic gate.`,
              range: range,
            })),
          ];

          const code = model.getValue();
          const definedVariables = new Set();
          const varRegex = /\b(?:input\s+([A-Z_][A-Z0-9_]*)|([A-Z_][A-Z0-9_]*)\s*=)/g;
          let match;
          while ((match = varRegex.exec(code)) !== null) {
            const varName = match[1] || match[2];
            if (varName) {
              definedVariables.add(varName);
            }
          }

          definedVariables.forEach(varName => {
            suggestions.push({
              label: varName,
              kind: monaco.languages.CompletionItemKind.Variable,
              insertText: varName,
              range: range,
            });
          });

          return { suggestions: suggestions };
        }
      });

      monaco.editor.defineTheme('gramby-dark', {
        base: 'vs-dark',
        inherit: true,
        rules: [
          { token: 'keyword', foreground: '569CD6' },
          { token: 'gate', foreground: 'C586C0' },
          { token: 'variable', foreground: '9CDCFE' },
          { token: 'comment', foreground: '6A9955' },
          { token: 'delimiter', foreground: 'D4D4D4' }
        ],
        colors: {}
      });

      // --- NEW: LOAD SAVED FONT SIZE ---
      const FONT_SIZE_KEY = 'grambyEditorFontSize';
      const DEFAULT_FONT_SIZE = 14;
      // Get the saved size from localStorage, or use the default if nothing is saved
      const initialFontSize = parseInt(localStorage.getItem(FONT_SIZE_KEY)) || DEFAULT_FONT_SIZE;
      // --- END LOAD FONT SIZE ---

      const editor = monaco.editor.create(document.getElementById('container'), {
        value: `/ Grambyscript example /\ninput A;\ninput B;\n\nRESULT = A and B;\noutput FINAL_OUT = RESULT;`,
        language: 'grambyscript',
        theme: 'gramby-dark',
        minimap: { enabled: false },
        fontSize: initialFontSize // Use the loaded font size here
      });

      const fontDecreaseButton = document.getElementById('font-decrease');
      const fontIncreaseButton = document.getElementById('font-increase');
      const MIN_FONT_SIZE = 8;
      const MAX_FONT_SIZE = 40;

      fontIncreaseButton.addEventListener('click', () => {
        let currentSize = editor.getOption(monaco.editor.EditorOption.fontSize);
        if (currentSize < MAX_FONT_SIZE) {
          const newSize = currentSize + 1;
          editor.updateOptions({ fontSize: newSize });
          // --- NEW: SAVE FONT SIZE ---
          localStorage.setItem(FONT_SIZE_KEY, newSize);
        }
      });

      fontDecreaseButton.addEventListener('click', () => {
        let currentSize = editor.getOption(monaco.editor.EditorOption.fontSize);
        if (currentSize > MIN_FONT_SIZE) {
          const newSize = currentSize - 1;
          editor.updateOptions({ fontSize: newSize });
          // --- NEW: SAVE FONT SIZE ---
          localStorage.setItem(FONT_SIZE_KEY, newSize);
        }
      });

      const runButton = document.getElementById('run-button');
      const modalOverlay = document.getElementById('modal-overlay');
      const outputBox = document.getElementById('output-box');
      const copyIcon = document.getElementById('copy-icon');
      const closeButton = document.getElementById('close-button');
      const outputText = document.getElementById('output-text');

      runButton.addEventListener('click', () => {
        let code = editor.getValue();
        code = code.replace(/\/.*?\//gs, '');
        
        let parser = new Parser();
        let compileStack = new CompileStack();
        parser.Variable = {};

        parser.PreCompile(code);
        parser.Compile(compileStack);

        outputText.textContent = compileStack.terminate();
        modalOverlay.style.display = 'block';
        outputBox.style.display = 'block';
      });

      copyIcon.addEventListener('click', () => {
        navigator.clipboard.writeText(outputText.textContent);
        copyIcon.textContent = 'âœ…';
        setTimeout(() => copyIcon.textContent = 'ðŸ“‹', 1000);
      });

      const closeOutput = () => {
        modalOverlay.style.display = 'none';
        outputBox.style.display = 'none';
      }

      closeButton.addEventListener('click', closeOutput);
      modalOverlay.addEventListener('click', closeOutput);
    });
  </script>
</body>
</html>